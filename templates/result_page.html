<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1,0">
    <title>Saved Results</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 50px;
        }
        .folder {
            margin-bottom: 10px;
            font-weight: bold;
        }
        #frames-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        .frame-container {
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .metadata {
            font-size: 12px;
            color: #888;
        }
        #class-select, #model-select {
            display: flex;
            justify-content: flex-start;
            gap: 20px;
            margin-top: 10px;
            margin-right: 10px;
            padding: 10px 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
   <h1>Saved Results</h1>
   <button onclick="location.href='/'">Back to Main</button>
   <select id="class-select" onchange="filterFrames()">
    <option value="">All Classes</option>
   </select>

   <select id="model-select" onchange="filterFrames()">
    <option value="">All Models</option>
   </select>

   <div id="frames-container"></div>

   <script>
       let frames = {};
       async function fetchSavedFrames() {
            const response = await fetch('/list_saved_frames');
            frames = await response.json();
            populateFilterOptions();
            const container = document.getElementById('frames-container');

            for (const sourceId in frames) {
                const sourceFolder = document.createElement('div');
                sourceFolder.classList.add('folder', 'source-folder');
                sourceFolder.setAttribute('data-source-id', sourceId);
                sourceFolder.textContent = `Source: ${sourceId}`;
                container.appendChild(sourceFolder);

                for (const modelType in frames[sourceId]) {
                    const modelFolder = document.createElement('div');
                    modelFolder.classList.add('folder', 'model-folder');
                    modelFolder.setAttribute('data-model-type', modelType);
                    modelFolder.textContent = `Model: ${modelType}`;
                    sourceFolder.appendChild(modelFolder);

                    for (const date in frames[sourceId][modelType]) {
                        const dateFolder = document.createElement('div');
                        dateFolder.classList.add('folder', 'date-folder');
                        dateFolder.setAttribute('data-date', date);
                        dateFolder.textContent = `Date: ${date}`;
                        modelFolder.appendChild(dateFolder);

                        for (const className in frames[sourceId][modelType][date]) {
                            const classNameFolder = document.createElement('div');
                            classNameFolder.classList.add('folder', 'class-folder');
                            classNameFolder.setAttribute('data-class-name', className);
                            classNameFolder.textContent = `Class: ${className}`;
                            dateFolder.appendChild(classNameFolder);

                            for (const detection in frames[sourceId][modelType][date][className]) {
                                const detectionFolder = document.createElement('div');
                                detectionFolder.classList.add('folder', 'detection-folder');
                                detectionFolder.setAttribute('data-detectio', detection);
                                detectionFolder.textContent = `Detection: ${detection}`;
                                classNameFolder.appendChild(detectionFolder);

                                const frameContainer = document.createElement('div');
                                frameContainer.classList.add('frame-container');
                                detectionFolder.appendChild(frameContainer);

                                const filenames = frames[sourceId][modelType][date][className][detection];
                                filenames.sort((a, b) => {
                                    const timestampA = extractTimestamp(a);
                                    const timestampB = extractTimestamp(b);
                                    return timestampA - timestampB;
                                });

                                filenames.forEach(filename => {
                                    const img = document.createElement('img');
                                    img.src = `/saved_frames/${sourceId}/${modelType}/${date}/${className}/${detection}/${filename}`;
                                    frameContainer.appendChild(img);
                                    fetchAndDisplayMetadata(frameContainer, sourceId, modelType, date, className, detection, filename);
                                });
                            }
                        }
                    }
                }
            }
            filterFrames();
       }
       function populateFilterOptions() {
        const classSelect = document.getElementById('class-select');
        const modelSelect = document.getElementById('model-select');

        const classes = new Set();
        const models = new Set();

        for (const sourceId in frames) {
            for (const modelType in frames[sourceId]) {
                models.add(modelType);
                for (const date in frames[sourceId][modelType]) {
                    for (const className in frames[sourceId][modelType][date]) {
                        classes.add(className);
                    }
                }
            }
        }

        classes.forEach(className => {
            const option = document.createElement('option');
            option.value = className;
            option.textContent = className;
            classSelect.appendChild(option);
        });

        models.forEach(modelType => {
            const option = document.createElement('option');
            option.value = modelType;
            option.textContent = modelType;
            modelSelect.appendChild(option);
        });
    }
    function filterFrames() {
            const classFilter = document.getElementById('class-select').value;
            const modelFilter = document.getElementById('model-select').value;
            const container = document.getElementById('frames-container');

            for (const sourceId in frames) {
                const sourceFolder = container.querySelector(`.source-folder[data-source-id="${sourceId}"]`);
                for (const modelType in frames[sourceId]) {
                    const modelFolder = sourceFolder.querySelector(`.model-folder[data-model-type="${modelType}"]`);
                    modelFolder.style.display = modelFilter && modelType !== modelFilter ? 'none' : '';

                    for (const date in frames[sourceId][modelType]) {
                        const dateFolder = modelFolder.querySelector(`.date-folder[data-date="${date}"]`);

                        for (const className in frames[sourceId][modelType][date]) {
                            const classNameFolder = dateFolder.querySelector(`.class-folder[data-class-name="${className}"]`);
                            classNameFolder.style.display = classFilter && className !== classFilter ? 'none' : '';
                        }
                    }
                }
            }
        }

        function extractTimestamp(filename){
           const match = filename.match(/(\d{4})-(\d{2})-(\d{2})_(\d{2})-(\d{2})-(\d{2})-(\d{3})\.jpg/);
           if (match){
               const [, year, month, day, hour, minute, second, millisecond] = match;
               return new Date(`${year}-${month}-${day}T${hour}:${minute}:${second}.${millisecond}Z`).getTime();
           }
           return 0;
        }
        function createMetadataElement(metadata) {
            const metadataDiv = document.createElement('div');
            metadataDiv.className = 'metadata';
            metadataDiv.textContent = JSON.stringify(metadata, null, 2);
            return metadataDiv;
        }

        async function fetchAndDisplayMetadata(container, sourceId, modelType, date, className, detection, filename) {
            const metadataFilename = filename.replace('.jpg', '.json');
            const response = await fetch(`/saved_frames/${sourceId}/${modelType}/${date}/${className}/${detection}/${metadataFilename}`);
            const metadata = await response.json();
            container.appendChild(createMetadataElement(metadata));
        }

        fetchSavedFrames();
   </script>
</body>
</html>